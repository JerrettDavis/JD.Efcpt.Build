<Project>

  <!-- Resolve the tasks assembly -->
  <PropertyGroup>
    <!-- Prefer the packed layout under /tasks/net8.0 when present (NuGet package scenario) -->
    <_EfcptTasksDir>$(MSBuildThisFileDirectory)..\tasks\$(TargetFramework)\</_EfcptTasksDir>
    <_EfcptTasksAssembly>$(_EfcptTasksDir)JD.Efcpt.Build.Tasks.dll</_EfcptTasksAssembly>

    <!-- Dev/CI fallback: use the sibling Tasks project build output when the packed layout is not present -->
    <_EfcptTasksDir Condition="!Exists('$(_EfcptTasksAssembly)')">$(MSBuildThisFileDirectory)..\..\JD.Efcpt.Build.Tasks\bin\$(Configuration)\$(TargetFramework)\</_EfcptTasksDir>
    <_EfcptTasksAssembly Condition="!Exists('$(_EfcptTasksAssembly)')">$(_EfcptTasksDir)JD.Efcpt.Build.Tasks.dll</_EfcptTasksAssembly>
  </PropertyGroup>

  <UsingTask TaskName="JD.Efcpt.Build.Tasks.ResolveSqlProjAndInputs"
             AssemblyFile="$(_EfcptTasksAssembly)"
             Condition="Exists('$(_EfcptTasksAssembly)')" />

  <UsingTask TaskName="JD.Efcpt.Build.Tasks.EnsureDacpacBuilt"
             AssemblyFile="$(_EfcptTasksAssembly)"
             Condition="Exists('$(_EfcptTasksAssembly)')" />

  <UsingTask TaskName="JD.Efcpt.Build.Tasks.StageEfcptInputs"
             AssemblyFile="$(_EfcptTasksAssembly)"
             Condition="Exists('$(_EfcptTasksAssembly)')" />

  <UsingTask TaskName="JD.Efcpt.Build.Tasks.ComputeFingerprint"
             AssemblyFile="$(_EfcptTasksAssembly)"
             Condition="Exists('$(_EfcptTasksAssembly)')" />

  <UsingTask TaskName="JD.Efcpt.Build.Tasks.RunEfcpt"
             AssemblyFile="$(_EfcptTasksAssembly)"
             Condition="Exists('$(_EfcptTasksAssembly)')" />

  <UsingTask TaskName="JD.Efcpt.Build.Tasks.RenameGeneratedFiles"
             AssemblyFile="$(_EfcptTasksAssembly)"
             Condition="Exists('$(_EfcptTasksAssembly)')" />

  <!-- Main pipeline -->
  <Target Name="EfcptResolveInputs"
          Condition="'$(EfcptEnabled)' == 'true'">
    <ResolveSqlProjAndInputs
        ProjectFullPath="$(MSBuildProjectFullPath)"
        ProjectDirectory="$(MSBuildProjectDirectory)"
        Configuration="$(Configuration)"
        ProjectReferences="@(ProjectReference)"
        SqlProjOverride="$(EfcptSqlProj)"
        ConfigOverride="$(EfcptConfig)"
        RenamingOverride="$(EfcptRenaming)"
        TemplateDirOverride="$(EfcptTemplateDir)"
        SolutionDir="$(EfcptSolutionDir)"
        ProbeSolutionDir="$(EfcptProbeSolutionDir)"
        OutputDir="$(EfcptOutput)"
        DefaultsRoot="$(MSBuildThisFileDirectory)..\contentFiles\any\any\Defaults"
        DumpResolvedInputs="$(EfcptDumpResolvedInputs)">
      <Output TaskParameter="SqlProjPath" PropertyName="_EfcptSqlProj" />
      <Output TaskParameter="ResolvedConfigPath" PropertyName="_EfcptResolvedConfig" />
      <Output TaskParameter="ResolvedRenamingPath" PropertyName="_EfcptResolvedRenaming" />
      <Output TaskParameter="ResolvedTemplateDir" PropertyName="_EfcptResolvedTemplateDir" />
    </ResolveSqlProjAndInputs>
  </Target>

  <Target Name="EfcptEnsureDacpac"
          DependsOnTargets="EfcptResolveInputs"
          Condition="'$(EfcptEnabled)' == 'true'">
    <EnsureDacpacBuilt
        SqlProjPath="$(_EfcptSqlProj)"
        Configuration="$(Configuration)"
        MsBuildExe="$(MSBuildBinPath)msbuild.exe"
        DotNetExe="$(EfcptDotNetExe)"
        LogVerbosity="$(EfcptLogVerbosity)">
      <Output TaskParameter="DacpacPath" PropertyName="_EfcptDacpacPath" />
    </EnsureDacpacBuilt>
  </Target>

  <Target Name="EfcptStageInputs"
          DependsOnTargets="EfcptEnsureDacpac"
          Condition="'$(EfcptEnabled)' == 'true'">
    <StageEfcptInputs
        OutputDir="$(EfcptOutput)"
        ConfigPath="$(_EfcptResolvedConfig)"
        RenamingPath="$(_EfcptResolvedRenaming)"
        TemplateDir="$(_EfcptResolvedTemplateDir)"
        LogVerbosity="$(EfcptLogVerbosity)">
      <Output TaskParameter="StagedConfigPath" PropertyName="_EfcptStagedConfig" />
      <Output TaskParameter="StagedRenamingPath" PropertyName="_EfcptStagedRenaming" />
      <Output TaskParameter="StagedTemplateDir" PropertyName="_EfcptStagedTemplateDir" />
    </StageEfcptInputs>
  </Target>

  <Target Name="EfcptComputeFingerprint"
          DependsOnTargets="EfcptStageInputs"
          Condition="'$(EfcptEnabled)' == 'true'">
    <ComputeFingerprint
        DacpacPath="$(_EfcptDacpacPath)"
        ConfigPath="$(_EfcptStagedConfig)"
        RenamingPath="$(_EfcptStagedRenaming)"
        TemplateDir="$(_EfcptStagedTemplateDir)"
        FingerprintFile="$(EfcptFingerprintFile)"
        LogVerbosity="$(EfcptLogVerbosity)">
      <Output TaskParameter="Fingerprint" PropertyName="_EfcptFingerprint" />
      <Output TaskParameter="HasChanged" PropertyName="_EfcptFingerprintChanged" />
    </ComputeFingerprint>
  </Target>

  <Target Name="EfcptGenerateModels"
          DependsOnTargets="EfcptComputeFingerprint"
          BeforeTargets="CoreCompile"
          Condition="'$(EfcptEnabled)' == 'true' and '$(_EfcptFingerprintChanged)' == 'true'">
    <MakeDir Directories="$(EfcptGeneratedDir)" />
    <RunEfcpt
        ToolMode="$(EfcptToolMode)"
        ToolPackageId="$(EfcptToolPackageId)"
        ToolVersion="$(EfcptToolVersion)"
        ToolRestore="$(EfcptToolRestore)"
        ToolCommand="$(EfcptToolCommand)"
        ToolPath="$(EfcptToolPath)"
        DotNetExe="$(EfcptDotNetExe)"
        WorkingDirectory="$(ProjectDir)"
        DacpacPath="$(_EfcptDacpacPath)"
        ConfigPath="$(_EfcptStagedConfig)"
        RenamingPath="$(_EfcptStagedRenaming)"
        TemplateDir="$(_EfcptStagedTemplateDir)"
        OutputDir="$(EfcptGeneratedDir)"
        LogVerbosity="$(EfcptLogVerbosity)" />
    <RenameGeneratedFiles
        GeneratedDir="$(EfcptGeneratedDir)"
        LogVerbosity="$(EfcptLogVerbosity)" />
    <WriteLinesToFile File="$(EfcptStampFile)" Lines="$(_EfcptFingerprint)" Overwrite="true" />
  </Target>

  <!-- Always include generated files if present; compilation depends on them implicitly -->
  <Target Name="EfcptAddToCompile"
          BeforeTargets="CoreCompile"
          DependsOnTargets="EfcptGenerateModels"
          Condition="'$(EfcptEnabled)' == 'true' and Exists('$(EfcptGeneratedDir)')">
    <ItemGroup>
      <!-- Include any .g.cs either directly under the root or a Models subfolder (efcpt default) -->
      <Compile Include="$(EfcptGeneratedDir)**\*.g.cs" Visible="false" />
      <Compile Include="$(EfcptGeneratedDir)Models\**\*.g.cs" Visible="false" />
      <Compile Include="$(EfcptGeneratedDir)Models\**\*.cs" Visible="false" Condition="!Exists('$(EfcptGeneratedDir)**\*.g.cs')" />
    </ItemGroup>
  </Target>

</Project>
