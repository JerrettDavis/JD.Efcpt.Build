<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--Generated by JD.MSBuild.Fluent-->
  <!--Late-evaluated property overrides set in targets file (after project import) to see final property values.-->
  <PropertyGroup>
    <!--Derive UseNullableReferenceTypes from project's Nullable setting for zero-config scenarios-->
    <EfcptConfigUseNullableReferenceTypes Condition="('$(EfcptConfigUseNullableReferenceTypes)' == '') and (('$(Nullable)' == 'enable') or ('$(Nullable)' == 'Enable'))">true</EfcptConfigUseNullableReferenceTypes>
    <EfcptConfigUseNullableReferenceTypes Condition="('$(EfcptConfigUseNullableReferenceTypes)' == '') and ('$(Nullable)' != '')">false</EfcptConfigUseNullableReferenceTypes>
  </PropertyGroup>
  <!--SQL Project Detection: Detect SQL database projects via SDK attribute or MSBuild properties. Must be in targets file for SDK property availability.-->
  <Target Name="_EfcptDetectSqlProject" BeforeTargets="BeforeBuild;BeforeRebuild">
    <DetectSqlProject DSP="$(DSP)" ProjectPath="$(MSBuildProjectFullPath)" SqlServerVersion="$(SqlServerVersion)">
      <Output TaskParameter="IsSqlProject" PropertyName="_EfcptIsSqlProject" />
    </DetectSqlProject>
    <PropertyGroup Condition="'$(_EfcptIsSqlProject)' == ''">
      <_EfcptIsSqlProject>false</_EfcptIsSqlProject>
    </PropertyGroup>
  </Target>
  <!--Determine the correct task assembly path based on MSBuild runtime and version.-->
  <PropertyGroup>
    <_EfcptTasksFolder Condition="'$(MSBuildRuntimeType)' == 'Core' and $([MSBuild]::VersionGreaterThanOrEquals('$(MSBuildVersion)', '18.0'))">net10.0</_EfcptTasksFolder>
    <_EfcptTasksFolder Condition="('$(_EfcptTasksFolder)' == '') and ('$(MSBuildRuntimeType)' == 'Core' and $([MSBuild]::VersionGreaterThanOrEquals('$(MSBuildVersion)', '17.14')))">net10.0</_EfcptTasksFolder>
    <_EfcptTasksFolder Condition="('$(_EfcptTasksFolder)' == '') and ('$(MSBuildRuntimeType)' == 'Core' and $([MSBuild]::VersionGreaterThanOrEquals('$(MSBuildVersion)', '17.12')))">net9.0</_EfcptTasksFolder>
    <_EfcptTasksFolder Condition="('$(_EfcptTasksFolder)' == '') and ('$(MSBuildRuntimeType)' == 'Core')">net8.0</_EfcptTasksFolder>
    <_EfcptTasksFolder Condition="'$(_EfcptTasksFolder)' == ''">net472</_EfcptTasksFolder>
    <_EfcptTaskAssembly>$(MSBuildThisFileDirectory)\..\tasks\$(_EfcptTasksFolder)\JD.Efcpt.Build.Tasks.dll</_EfcptTaskAssembly>
    <_EfcptTaskAssembly Condition="!Exists('$(_EfcptTaskAssembly)')">$(MSBuildThisFileDirectory)\..\..\JD.Efcpt.Build.Tasks\bin\$(Configuration)\$(_EfcptTasksFolder)\JD.Efcpt.Build.Tasks.dll</_EfcptTaskAssembly>
    <_EfcptTaskAssembly Condition="(!Exists('$(_EfcptTaskAssembly)')) and ('$(Configuration)' == '')">$(MSBuildThisFileDirectory)\..\..\JD.Efcpt.Build.Tasks\bin\Debug\$(_EfcptTasksFolder)\JD.Efcpt.Build.Tasks.dll</_EfcptTaskAssembly>
  </PropertyGroup>
  <!--Diagnostic output for task assembly selection (when EfcptLogVerbosity=detailed)-->
  <Target Name="_EfcptLogTaskAssemblyInfo" BeforeTargets="EfcptResolveInputs;EfcptResolveInputsForDirectDacpac" Condition="('$(EfcptEnabled)' == 'true') and ('$(EfcptLogVerbosity)' == 'detailed')">
    <Message Text="EFCPT Task Assembly Selection:" Importance="high" />
    <Message Text="  MSBuildRuntimeType: $(MSBuildRuntimeType)" Importance="high" />
    <Message Text="  MSBuildVersion: $(MSBuildVersion)" Importance="high" />
    <Message Text="  Selected TasksFolder: $(_EfcptTasksFolder)" Importance="high" />
    <Message Text="  TaskAssembly Path: $(_EfcptTaskAssembly)" Importance="high" />
    <Message Text="  TaskAssembly Exists: $([System.IO.File]::Exists('$(_EfcptTaskAssembly)'))" Importance="high" />
  </Target>
  <!--Register MSBuild tasks using centralized registry.-->
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.AddSqlFileWarnings" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.ApplyConfigOverrides" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.CheckSdkVersion" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.ComputeFingerprint" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.DetectSqlProject" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.EnsureDacpacBuilt" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.FinalizeBuildProfiling" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.InitializeBuildProfiling" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.QuerySchemaMetadata" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.RenameGeneratedFiles" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.ResolveDbContextName" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.ResolveSqlProjAndInputs" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.RunEfcpt" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.RunSqlPackage" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.SerializeConfigProperties" AssemblyFile="$(_EfcptTaskAssembly)" />
  <UsingTask TaskName="JD.Efcpt.Build.Tasks.StageEfcptInputs" AssemblyFile="$(_EfcptTaskAssembly)" />
  <!--Build Profiling: Initialize profiling at the start of the build pipeline. Runs early to ensure profiler availability.-->
  <Target Name="_EfcptInitializeProfiling" BeforeTargets="_EfcptDetectSqlProject" Condition="'$(EfcptEnabled)' == 'true'">
    <InitializeBuildProfiling ConfigPath="$(_EfcptResolvedConfig)" Configuration="$(Configuration)" DacpacPath="$(_EfcptDacpacPath)" EnableProfiling="$(EfcptEnableProfiling)" ProjectName="$(MSBuildProjectName)" ProjectPath="$(MSBuildProjectFullPath)" Provider="$(EfcptProvider)" RenamingPath="$(_EfcptResolvedRenaming)" SqlProjectPath="$(_EfcptSqlProj)" TargetFramework="$(TargetFramework)" TemplateDir="$(_EfcptResolvedTemplateDir)" />
  </Target>
  <!--SDK Version Check: Warns users when a newer SDK version is available. Opt-in via EfcptCheckForUpdates=true. Results are cached for 24 hours.-->
  <Target Name="_EfcptCheckForUpdates" BeforeTargets="Build" Condition="('$(EfcptCheckForUpdates)' == 'true') and ('$(EfcptSdkVersion)' != '')">
    <CheckSdkVersion CacheHours="$(EfcptUpdateCheckCacheHours)" CurrentVersion="$(EfcptSdkVersion)" ForceCheck="$(EfcptForceUpdateCheck)" PackageId="JD.Efcpt.Sdk" WarningLevel="$(EfcptSdkVersionWarningLevel)">
      <Output TaskParameter="LatestVersion" PropertyName="_EfcptLatestVersion" />
      <Output TaskParameter="UpdateAvailable" PropertyName="_EfcptUpdateAvailable" />
    </CheckSdkVersion>
  </Target>
  <!--SQL Project Generation Pipeline: Extract database schema to SQL scripts for SQL projects. Workflow: Database → SQL Scripts → DACPAC → EF Core Models-->
  <!--Lifecycle hooks: BeforeSqlProjGeneration, AfterSqlProjGeneration, BeforeEfcptGeneration, AfterEfcptGeneration-->
  <!--Lifecycle hook: BeforeSqlProjGeneration-->
  <Target Name="BeforeSqlProjGeneration" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' == 'true')" />
  <!--Query database schema for fingerprinting-->
  <Target Name="EfcptQueryDatabaseSchemaForSqlProj" DependsOnTargets="BeforeSqlProjGeneration" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' == 'true')">
    <Error Text="SqlProj generation requires a connection string. Set EfcptConnectionString, EfcptAppSettings, or EfcptAppConfig." Condition="(('$(EfcptConnectionString)' == '') and ('$(EfcptAppSettings)' == '')) and ('$(EfcptAppConfig)' == '')" />
    <Message Text="Querying database schema for fingerprinting..." Importance="high" />
    <QuerySchemaMetadata ConnectionString="$(EfcptConnectionString)" LogVerbosity="$(EfcptLogVerbosity)" OutputDir="$(EfcptOutput)" Provider="$(EfcptProvider)">
      <Output TaskParameter="SchemaFingerprint" PropertyName="_EfcptSchemaFingerprint" />
    </QuerySchemaMetadata>
    <Message Text="Database schema fingerprint: $(_EfcptSchemaFingerprint)" Importance="normal" />
  </Target>
  <!--Extract database schema to SQL scripts using sqlpackage-->
  <Target Name="EfcptExtractDatabaseSchemaToScripts" DependsOnTargets="EfcptQueryDatabaseSchemaForSqlProj" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' == 'true')">
    <PropertyGroup>
      <_EfcptScriptsDir>$(EfcptSqlScriptsDir)</_EfcptScriptsDir>
    </PropertyGroup>
    <Message Text="Extracting database schema to SQL scripts in SQL project: $(_EfcptScriptsDir)" Importance="high" />
    <ItemGroup>
      <_EfcptGeneratedScripts Include="$(_EfcptScriptsDir)**\*.sql" />
    </ItemGroup>
    <Delete Condition="'@(_EfcptGeneratedScripts)' != ''" Files="@(_EfcptGeneratedScripts)" />
    <RunSqlPackage ConnectionString="$(EfcptConnectionString)" DotNetExe="$(EfcptDotNetExe)" ExtractTarget="SchemaObjectType" LogVerbosity="$(EfcptLogVerbosity)" TargetDirectory="$(_EfcptScriptsDir)" TargetFramework="$(TargetFramework)" ToolPath="$(EfcptSqlPackageToolPath)" ToolRestore="$(EfcptSqlPackageToolRestore)" ToolVersion="$(EfcptSqlPackageToolVersion)" WorkingDirectory="$(EfcptOutput)">
      <Output TaskParameter="ExtractedPath" PropertyName="_EfcptExtractedScriptsPath" />
    </RunSqlPackage>
    <Message Text="Extracted SQL scripts to: $(_EfcptExtractedScriptsPath)" Importance="high" />
  </Target>
  <!--Add auto-generation warnings to SQL files-->
  <Target Name="EfcptAddSqlFileWarnings" DependsOnTargets="EfcptExtractDatabaseSchemaToScripts" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' == 'true')">
    <Message Importance="high" Text="Adding auto-generation warnings to SQL files..." />
    <PropertyGroup>
      <_EfcptDatabaseName>$([System.Text.RegularExpressions.Regex]::Match($(EfcptConnectionString), 'Database\s*=\s*\"?([^;"]+)\"?').Groups[1].Value)</_EfcptDatabaseName>
      <_EfcptDatabaseName>$([System.Text.RegularExpressions.Regex]::Match($(EfcptConnectionString), 'Initial Catalog\s*=\s*\"?([^;"]+)\"?').Groups[1].Value)</_EfcptDatabaseName>
    </PropertyGroup>
    <AddSqlFileWarnings DatabaseName="$(_EfcptDatabaseName)" LogVerbosity="$(EfcptLogVerbosity)" ScriptsDirectory="$(_EfcptScriptsDir)" />
  </Target>
  <!--Lifecycle hook: AfterSqlProjGeneration-->
  <!--This runs after SQL scripts are generated in the SQL project-->
  <!--The SQL project will build normally and create its DACPAC-->
  <!--DataAccess projects that reference this SQL project will wait for this to complete-->
  <Target Name="AfterSqlProjGeneration" BeforeTargets="Build" DependsOnTargets="EfcptAddSqlFileWarnings" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' == 'true')">
    <Message Importance="high" Text="_EfcptIsSqlProject: $(_EfcptIsSqlProject)" />
    <Message Importance="high" Text="SQL script generation complete. SQL project will build to DACPAC." />
  </Target>
  <!--Main pipeline-->
  <!--When NOT in a SQL project, resolve inputs normally-->
  <Target Name="EfcptResolveInputs" Condition="(('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')) and ('$(EfcptDacpac)' == '')">
    <ResolveSqlProjAndInputs AutoDetectWarningLevel="$(EfcptAutoDetectWarningLevel)" ConfigOverride="$(EfcptConfig)" Configuration="$(Configuration)" DefaultsRoot="$(MSBuildThisFileDirectory)Defaults" DumpResolvedInputs="$(EfcptDumpResolvedInputs)" EfcptAppConfig="$(EfcptAppConfig)" EfcptAppSettings="$(EfcptAppSettings)" EfcptConnectionString="$(EfcptConnectionString)" EfcptConnectionStringName="$(EfcptConnectionStringName)" OutputDir="$(EfcptOutput)" ProbeSolutionDir="$(EfcptProbeSolutionDir)" ProjectDirectory="$(MSBuildProjectDirectory)" ProjectFullPath="$(MSBuildProjectFullPath)" ProjectReferences="@(ProjectReference)" RenamingOverride="$(EfcptRenaming)" SolutionDir="$(EfcptSolutionDir)" SolutionPath="$(EfcptSolutionPath)" SqlProjOverride="$(EfcptSqlProj)" TemplateDirOverride="$(EfcptTemplateDir)">
      <Output TaskParameter="SqlProjPath" PropertyName="_EfcptSqlProj" />
      <Output TaskParameter="ResolvedConfigPath" PropertyName="_EfcptResolvedConfig" />
      <Output TaskParameter="ResolvedRenamingPath" PropertyName="_EfcptResolvedRenaming" />
      <Output TaskParameter="ResolvedTemplateDir" PropertyName="_EfcptResolvedTemplateDir" />
      <Output TaskParameter="ResolvedConnectionString" PropertyName="_EfcptResolvedConnectionString" />
      <Output TaskParameter="UseConnectionString" PropertyName="_EfcptUseConnectionString" />
      <Output TaskParameter="IsUsingDefaultConfig" PropertyName="_EfcptIsUsingDefaultConfig" />
    </ResolveSqlProjAndInputs>
  </Target>
  <!--Simplified resolution for direct DACPAC mode (bypass SQL project detection)-->
  <Target Name="EfcptResolveInputsForDirectDacpac" Condition="('$(EfcptEnabled)' == 'true') and ('$(EfcptDacpac)' != '')">
    <PropertyGroup>
      <_EfcptResolvedConfig>$(MSBuildProjectDirectory)\$(EfcptConfig)</_EfcptResolvedConfig>
      <_EfcptResolvedConfig>$(MSBuildThisFileDirectory)Defaults\efcpt-config.json</_EfcptResolvedConfig>
      <_EfcptResolvedRenaming>$(MSBuildProjectDirectory)\$(EfcptRenaming)</_EfcptResolvedRenaming>
      <_EfcptResolvedRenaming>$(MSBuildThisFileDirectory)Defaults\efcpt.renaming.json</_EfcptResolvedRenaming>
      <_EfcptResolvedTemplateDir>$(MSBuildProjectDirectory)\$(EfcptTemplateDir)</_EfcptResolvedTemplateDir>
      <_EfcptResolvedTemplateDir>$(MSBuildThisFileDirectory)Defaults\Template</_EfcptResolvedTemplateDir>
      <_EfcptIsUsingDefaultConfig>true</_EfcptIsUsingDefaultConfig>
      <_EfcptUseConnectionString>false</_EfcptUseConnectionString>
    </PropertyGroup>
    <MakeDir Directories="$(EfcptOutput)" />
  </Target>
  <Target Name="EfcptQuerySchemaMetadataForDb" BeforeTargets="EfcptStageInputs" AfterTargets="EfcptResolveInputs" Condition="(('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')) and ('$(_EfcptUseConnectionString)' == 'true')">
    <QuerySchemaMetadata ConnectionString="$(_EfcptResolvedConnectionString)" LogVerbosity="$(EfcptLogVerbosity)" OutputDir="$(EfcptOutput)">
      <Output TaskParameter="SchemaFingerprint" PropertyName="_EfcptSchemaFingerprint" />
    </QuerySchemaMetadata>
  </Target>
  <Target Name="EfcptUseDirectDacpac" DependsOnTargets="EfcptResolveInputs;EfcptResolveInputsForDirectDacpac" Condition="(('$(EfcptEnabled)' == 'true') and ('$(_EfcptUseConnectionString)' != 'true')) and ('$(EfcptDacpac)' != '')">
    <PropertyGroup>
      <_EfcptDacpacPath>$(EfcptDacpac)</_EfcptDacpacPath>
      <_EfcptDacpacPath>$([System.IO.Path]::GetFullPath($([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(EfcptDacpac)'))))</_EfcptDacpacPath>
      <_EfcptUseDirectDacpac>true</_EfcptUseDirectDacpac>
    </PropertyGroup>
    <Error Text="EfcptDacpac was specified but the file does not exist: $(_EfcptDacpacPath)" Condition="!Exists('$(_EfcptDacpacPath)')" />
    <Message Text="Using pre-built DACPAC: $(_EfcptDacpacPath)" Importance="high" />
  </Target>
  <!--Build the SQL project using MSBuild's native task to ensure proper dependency ordering. This prevents race conditions when MSBuild runs in parallel mode - the SQL project build will complete before any targets that depend on this one can proceed. Note: The mode-specific condition (checking connection string vs dacpac mode) is on the MSBuild task, not the target, because target conditions evaluate before DependsOnTargets complete. The target's EfcptEnabled condition is a simple enable/disable check.-->
  <Target Name="EfcptBuildSqlProj" DependsOnTargets="EfcptResolveInputs;EfcptUseDirectDacpac" Condition="'$(EfcptEnabled)' == 'true'">
    <Message Text="Building SQL project: $(_EfcptSqlProj)" Importance="normal" Condition="(('$(_EfcptUseConnectionString)' != 'true') and ('$(_EfcptUseDirectDacpac)' != 'true')) and ('$(_EfcptSqlProj)' != '')" />
    <MSBuild Condition="(('$(_EfcptUseConnectionString)' != 'true') and ('$(_EfcptUseDirectDacpac)' != 'true')) and ('$(_EfcptSqlProj)' != '')" BuildInParallel="false" Projects="$(_EfcptSqlProj)" Properties="Configuration=$(Configuration)" Targets="Build" />
  </Target>
  <!--EfcptEnsureDacpac: Build dacpac if needed (not in connection string mode). Note: The condition check happens INSIDE the target (not on the target itself) because target conditions are evaluated before DependsOnTargets run.-->
  <Target Name="EfcptEnsureDacpacBuilt" DependsOnTargets="EfcptResolveInputs;EfcptUseDirectDacpac;EfcptBuildSqlProj" Condition="'$(EfcptEnabled)' == 'true'">
    <EnsureDacpacBuilt Condition="(('$(_EfcptUseConnectionString)' != 'true') and ('$(_EfcptUseDirectDacpac)' != 'true')) and ('$(_EfcptIsSqlProject)' != 'true')" Configuration="$(Configuration)" DotNetExe="$(EfcptDotNetExe)" LogVerbosity="$(EfcptLogVerbosity)" MsBuildExe="$(MSBuildBinPath)msbuild.exe" SqlProjPath="$(_EfcptSqlProj)">
      <Output TaskParameter="DacpacPath" PropertyName="_EfcptDacpacPath" />
    </EnsureDacpacBuilt>
  </Target>
  <!--Resolve DbContext name from SQL project, DACPAC, or connection string. This runs after DACPAC is ensured/resolved but before staging to allow the resolved name to be used as an override in ApplyConfigOverrides.-->
  <Target Name="EfcptResolveDbContextName" DependsOnTargets="EfcptResolveInputs;EfcptEnsureDacpacBuilt;EfcptUseDirectDacpac" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')">
    <ResolveDbContextName ConnectionString="$(_EfcptResolvedConnectionString)" DacpacPath="$(_EfcptDacpacPath)" ExplicitDbContextName="$(EfcptConfigDbContextName)" LogVerbosity="$(EfcptLogVerbosity)" SqlProjPath="$(_EfcptSqlProj)" UseConnectionStringMode="$(_EfcptUseConnectionString)">
      <Output TaskParameter="ResolvedDbContextName" PropertyName="_EfcptResolvedDbContextName" />
    </ResolveDbContextName>
    <PropertyGroup>
      <EfcptConfigDbContextName>$(_EfcptResolvedDbContextName)</EfcptConfigDbContextName>
    </PropertyGroup>
  </Target>
  <Target Name="EfcptStageInputs" DependsOnTargets="EfcptResolveInputs;EfcptEnsureDacpacBuilt;EfcptUseDirectDacpac;EfcptResolveDbContextName" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')">
    <StageEfcptInputs ConfigPath="$(_EfcptResolvedConfig)" LogVerbosity="$(EfcptLogVerbosity)" OutputDir="$(EfcptOutput)" ProjectDirectory="$(MSBuildProjectDirectory)" RenamingPath="$(_EfcptResolvedRenaming)" TargetFramework="$(TargetFramework)" TemplateDir="$(_EfcptResolvedTemplateDir)" TemplateOutputDir="$(EfcptGeneratedDir)">
      <Output TaskParameter="StagedConfigPath" PropertyName="_EfcptStagedConfig" />
      <Output TaskParameter="StagedRenamingPath" PropertyName="_EfcptStagedRenaming" />
      <Output TaskParameter="StagedTemplateDir" PropertyName="_EfcptStagedTemplateDir" />
    </StageEfcptInputs>
  </Target>
  <!--Apply MSBuild property overrides to the staged efcpt-config.json file. Runs after staging but before fingerprinting to ensure overrides are included in the hash.-->
  <Target Name="EfcptApplyConfigOverrides" DependsOnTargets="EfcptStageInputs" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')">
    <ApplyConfigOverrides ApplyOverrides="$(EfcptApplyMsBuildOverrides)" DbContextName="$(EfcptConfigDbContextName)" DbContextNamespace="$(EfcptConfigDbContextNamespace)" DbContextOutputPath="$(EfcptConfigDbContextOutputPath)" DiscoverMultipleResultSets="$(EfcptConfigDiscoverMultipleResultSets)" EnableOnConfiguring="$(EfcptConfigEnableOnConfiguring)" GenerateMermaidDiagram="$(EfcptConfigGenerateMermaidDiagram)" GenerationType="$(EfcptConfigGenerationType)" IsUsingDefaultConfig="$(_EfcptIsUsingDefaultConfig)" LogVerbosity="$(EfcptLogVerbosity)" MergeDacpacs="$(EfcptConfigMergeDacpacs)" ModelNamespace="$(EfcptConfigModelNamespace)" OutputPath="$(EfcptConfigOutputPath)" PreserveCasingWithRegex="$(EfcptConfigPreserveCasingWithRegex)" RefreshObjectLists="$(EfcptConfigRefreshObjectLists)" RemoveDefaultSqlFromBool="$(EfcptConfigRemoveDefaultSqlFromBool)" RootNamespace="$(EfcptConfigRootNamespace)" SoftDeleteObsoleteFiles="$(EfcptConfigSoftDeleteObsoleteFiles)" SplitDbContext="$(EfcptConfigSplitDbContext)" StagedConfigPath="$(_EfcptStagedConfig)" T4TemplatePath="$(EfcptConfigT4TemplatePath)" UseAlternateResultSetDiscovery="$(EfcptConfigUseAlternateResultSetDiscovery)" UseDataAnnotations="$(EfcptConfigUseDataAnnotations)" UseDatabaseNames="$(EfcptConfigUseDatabaseNames)" UseDatabaseNamesForRoutines="$(EfcptConfigUseDatabaseNamesForRoutines)" UseDateOnlyTimeOnly="$(EfcptConfigUseDateOnlyTimeOnly)" UseDecimalAnnotationForSprocs="$(EfcptConfigUseDecimalAnnotationForSprocs)" UseHierarchyId="$(EfcptConfigUseHierarchyId)" UseInflector="$(EfcptConfigUseInflector)" UseInternalAccessForRoutines="$(EfcptConfigUseInternalAccessForRoutines)" UseLegacyInflector="$(EfcptConfigUseLegacyInflector)" UseManyToManyEntity="$(EfcptConfigUseManyToManyEntity)" UseNoNavigations="$(EfcptConfigUseNoNavigations)" UseNodaTime="$(EfcptConfigUseNodaTime)" UseNullableReferenceTypes="$(EfcptConfigUseNullableReferenceTypes)" UsePrefixNavigationNaming="$(EfcptConfigUsePrefixNavigationNaming)" UseSchemaFolders="$(EfcptConfigUseSchemaFolders)" UseSchemaNamespaces="$(EfcptConfigUseSchemaNamespaces)" UseSpatial="$(EfcptConfigUseSpatial)" UseT4="$(EfcptConfigUseT4)" UseT4Split="$(EfcptConfigUseT4Split)" />
  </Target>
  <!--Serialize MSBuild config property overrides to a JSON string for fingerprinting. This ensures that changes to EfcptConfig* properties trigger regeneration.-->
  <Target Name="EfcptSerializeConfigProperties" DependsOnTargets="EfcptApplyConfigOverrides" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')">
    <SerializeConfigProperties DbContextName="$(EfcptConfigDbContextName)" DbContextNamespace="$(EfcptConfigDbContextNamespace)" DbContextOutputPath="$(EfcptConfigDbContextOutputPath)" DiscoverMultipleResultSets="$(EfcptConfigDiscoverMultipleResultSets)" EnableOnConfiguring="$(EfcptConfigEnableOnConfiguring)" GenerateMermaidDiagram="$(EfcptConfigGenerateMermaidDiagram)" GenerationType="$(EfcptConfigGenerationType)" MergeDacpacs="$(EfcptConfigMergeDacpacs)" ModelNamespace="$(EfcptConfigModelNamespace)" OutputPath="$(EfcptConfigOutputPath)" PreserveCasingWithRegex="$(EfcptConfigPreserveCasingWithRegex)" RefreshObjectLists="$(EfcptConfigRefreshObjectLists)" RemoveDefaultSqlFromBool="$(EfcptConfigRemoveDefaultSqlFromBool)" RootNamespace="$(EfcptConfigRootNamespace)" SoftDeleteObsoleteFiles="$(EfcptConfigSoftDeleteObsoleteFiles)" SplitDbContext="$(EfcptConfigSplitDbContext)" T4TemplatePath="$(EfcptConfigT4TemplatePath)" UseAlternateResultSetDiscovery="$(EfcptConfigUseAlternateResultSetDiscovery)" UseDataAnnotations="$(EfcptConfigUseDataAnnotations)" UseDatabaseNames="$(EfcptConfigUseDatabaseNames)" UseDatabaseNamesForRoutines="$(EfcptConfigUseDatabaseNamesForRoutines)" UseDateOnlyTimeOnly="$(EfcptConfigUseDateOnlyTimeOnly)" UseDecimalAnnotationForSprocs="$(EfcptConfigUseDecimalAnnotationForSprocs)" UseHierarchyId="$(EfcptConfigUseHierarchyId)" UseInflector="$(EfcptConfigUseInflector)" UseInternalAccessForRoutines="$(EfcptConfigUseInternalAccessForRoutines)" UseLegacyInflector="$(EfcptConfigUseLegacyInflector)" UseManyToManyEntity="$(EfcptConfigUseManyToManyEntity)" UseNoNavigations="$(EfcptConfigUseNoNavigations)" UseNodaTime="$(EfcptConfigUseNodaTime)" UseNullableReferenceTypes="$(EfcptConfigUseNullableReferenceTypes)" UsePrefixNavigationNaming="$(EfcptConfigUsePrefixNavigationNaming)" UseSchemaFolders="$(EfcptConfigUseSchemaFolders)" UseSchemaNamespaces="$(EfcptConfigUseSchemaNamespaces)" UseSpatial="$(EfcptConfigUseSpatial)" UseT4="$(EfcptConfigUseT4)" UseT4Split="$(EfcptConfigUseT4Split)">
      <Output TaskParameter="SerializedProperties" PropertyName="_EfcptSerializedConfigProperties" />
    </SerializeConfigProperties>
  </Target>
  <Target Name="EfcptComputeFingerprint" DependsOnTargets="EfcptSerializeConfigProperties" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')">
    <ComputeFingerprint ConfigPath="$(_EfcptStagedConfig)" ConfigPropertyOverrides="$(_EfcptSerializedConfigProperties)" DacpacPath="$(_EfcptDacpacPath)" DetectGeneratedFileChanges="$(EfcptDetectGeneratedFileChanges)" FingerprintFile="$(EfcptFingerprintFile)" GeneratedDir="$(EfcptGeneratedDir)" LogVerbosity="$(EfcptLogVerbosity)" RenamingPath="$(_EfcptStagedRenaming)" SchemaFingerprint="$(_EfcptSchemaFingerprint)" TemplateDir="$(_EfcptStagedTemplateDir)" ToolVersion="$(EfcptToolVersion)" UseConnectionStringMode="$(_EfcptUseConnectionString)">
      <Output TaskParameter="Fingerprint" PropertyName="_EfcptFingerprint" />
      <Output TaskParameter="HasChanged" PropertyName="_EfcptFingerprintChanged" />
    </ComputeFingerprint>
  </Target>
  <!--Lifecycle hook: BeforeEfcptGeneration-->
  <Target Name="BeforeEfcptGeneration" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')" />
  <Target Name="EfcptGenerateModels" BeforeTargets="CoreCompile" DependsOnTargets="BeforeEfcptGeneration" Inputs="$(_EfcptDacpacPath);$(_EfcptStagedConfig);$(_EfcptStagedRenaming)" Outputs="$(EfcptStampFile)" Condition="(('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')) and (('$(_EfcptFingerprintChanged)' == 'true' or !Exists($(EfcptStampFile))))">
    <MakeDir Directories="$(EfcptGeneratedDir)" />
    <RunEfcpt ConfigPath="$(_EfcptStagedConfig)" ConnectionString="$(_EfcptResolvedConnectionString)" DacpacPath="$(_EfcptDacpacPath)" DotNetExe="$(EfcptDotNetExe)" LogVerbosity="$(EfcptLogVerbosity)" OutputDir="$(EfcptGeneratedDir)" ProjectPath="$(MSBuildProjectFullPath)" Provider="$(EfcptProvider)" RenamingPath="$(_EfcptStagedRenaming)" TargetFramework="$(TargetFramework)" TemplateDir="$(_EfcptStagedTemplateDir)" ToolCommand="$(EfcptToolCommand)" ToolMode="$(EfcptToolMode)" ToolPackageId="$(EfcptToolPackageId)" ToolPath="$(EfcptToolPath)" ToolRestore="$(EfcptToolRestore)" ToolVersion="$(EfcptToolVersion)" UseConnectionStringMode="$(_EfcptUseConnectionString)" WorkingDirectory="$(EfcptOutput)" />
    <RenameGeneratedFiles GeneratedDir="$(EfcptGeneratedDir)" LogVerbosity="$(EfcptLogVerbosity)" />
    <WriteLinesToFile File="$(EfcptStampFile)" Lines="$(_EfcptFingerprint)" Overwrite="true" />
  </Target>
  <!--Lifecycle hook: AfterEfcptGeneration-->
  <Target Name="AfterEfcptGeneration" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')" />
  <!--======================================================================== Split Outputs: Separate Models project from Data project ======================================================================== When EfcptSplitOutputs=true, the Models project is the primary project that runs efcpt and generates all files. Entity models stay in Models, while DbContext and configurations are copied to the Data project. This approach works because Data depends on Models, so Models builds first and generates the code before Data needs the types.-->
  <!--Validate split outputs configuration and resolve Data project path. Ensures the Data project exists and is properly configured.-->
  <Target Name="EfcptValidateSplitOutputs" DependsOnTargets="EfcptGenerateModels" Condition="(('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')) and ('$(EfcptSplitOutputs)' == 'true')">
    <PropertyGroup>
      <_EfcptDataProjectPath>$(EfcptDataProject)</_EfcptDataProjectPath>
      <_EfcptDataProjectPath>$([System.IO.Path]::GetFullPath($([System.IO.Path]::Combine($(MSBuildProjectDirectory), $(EfcptDataProject)))))</_EfcptDataProjectPath>
    </PropertyGroup>
    <Error Text="EfcptSplitOutputs is enabled but EfcptDataProject is not set. Please specify the path to your Data project: &lt;EfcptDataProject&gt;..\MyProject.Data\MyProject.Data.csproj&lt;/EfcptDataProject&gt;" Condition="$(_EfcptDataProjectPath) == ''" />
    <Error Text="EfcptDataProject was specified but the file does not exist: $(_EfcptDataProjectPath)" Condition="!Exists($(_EfcptDataProjectPath))" />
    <PropertyGroup>
      <_EfcptDataDestDir>$(_EfcptDataProjectDir)$(EfcptDataProjectOutputSubdir)</_EfcptDataDestDir>
      <_EfcptDataProjectDir>$([System.IO.Path]::GetDirectoryName($(_EfcptDataProjectPath)))\</_EfcptDataProjectDir>
    </PropertyGroup>
    <Message Text="Split outputs enabled. DbContext and configurations will be copied to: $(_EfcptDataDestDir)" Importance="high" />
  </Target>
  <!--Copy generated DbContext and configuration files to the Data project. - DbContext files go to the root of the destination - Configuration files go to a Configurations subfolder - Files are deleted from the Models project after copying Only runs when source files exist (i.e., when generation actually occurred).-->
  <Target Name="EfcptCopyDataToDataProject" DependsOnTargets="EfcptValidateSplitOutputs" Condition="(('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')) and ('$(EfcptSplitOutputs)' == 'true')">
    <ItemGroup>
      <_EfcptDbContextFiles Include="$(EfcptGeneratedDir)*.g.cs" />
    </ItemGroup>
    <ItemGroup>
      <_EfcptConfigurationFiles Include="$(EfcptGeneratedDir)*Configuration.g.cs" />
      <_EfcptConfigurationFiles Include="$(EfcptGeneratedDir)Configurations\**\*.g.cs" />
    </ItemGroup>
    <PropertyGroup>
      <_EfcptHasFilesToCopy>true</_EfcptHasFilesToCopy>
    </PropertyGroup>
    <RemoveDir Condition="'$(_EfcptHasFilesToCopy)' == 'true' and Exists($(_EfcptDataDestDir))" Directories="$(_EfcptDataDestDir)" />
    <MakeDir Directories="$(_EfcptDataDestDir)" />
    <MakeDir Condition="'@(_EfcptConfigurationFiles)' != ''" Directories="$(_EfcptDataDestDir)Configurations" />
    <Copy Condition="'@(_EfcptDbContextFiles)' != ''" DestinationFolder="$(_EfcptDataDestDir)" SkipUnchangedFiles="true" SourceFiles="@(_EfcptDbContextFiles)">
      <Output TaskParameter="CopiedFiles" ItemName="_EfcptCopiedDataFiles" />
    </Copy>
    <Copy Condition="'@(_EfcptConfigurationFiles)' != ''" DestinationFolder="$(_EfcptDataDestDir)Configurations" SkipUnchangedFiles="true" SourceFiles="@(_EfcptConfigurationFiles)">
      <Output TaskParameter="CopiedFiles" ItemName="_EfcptCopiedDataFiles" />
    </Copy>
    <Message Text="Copied @(_EfcptCopiedDataFiles-&gt;Count()) data files to Data project: $(_EfcptDataDestDir)" Importance="high" Condition="'@(_EfcptCopiedDataFiles)' != ''" />
    <Message Text="Split outputs: No new files to copy (generation was skipped)" Importance="normal" Condition="'$(_EfcptHasFilesToCopy)' != 'true'" />
    <Delete Condition="'@(_EfcptDbContextFiles)' != ''" Files="@(_EfcptDbContextFiles)" />
    <Delete Condition="'@(_EfcptConfigurationFiles)' != ''" Files="@(_EfcptConfigurationFiles)" />
    <Message Text="Removed DbContext and configuration files from Models project" Importance="normal" Condition="'$(_EfcptHasFilesToCopy)' == 'true'" />
  </Target>
  <!--Include generated files in compilation. In split outputs mode (Models project), only include model files (from Models folder). In normal mode, include all generated files.-->
  <Target Name="EfcptAddToCompile" BeforeTargets="CoreCompile" DependsOnTargets="EfcptResolveInputs;EfcptUseDirectDacpac;EfcptEnsureDacpacBuilt;EfcptStageInputs;EfcptComputeFingerprint;EfcptGenerateModels;EfcptCopyDataToDataProject" Condition="('$(EfcptEnabled)' == 'true') and ('$(_EfcptIsSqlProject)' != 'true')">
    <ItemGroup>
      <Compile Include="$(EfcptGeneratedDir)**\*.g.cs" Condition="'$(EfcptSplitOutputs)' != 'true'" />
      <Compile Include="$(EfcptGeneratedDir)Models\**\*.g.cs" Condition="'$(EfcptSplitOutputs)' == 'true'" />
    </ItemGroup>
  </Target>
  <!--Include external data files from another project (for Data project consumption). Used when Data project has EfcptEnabled=false but needs to compile copied DbContext/configs.-->
  <Target Name="EfcptIncludeExternalData" BeforeTargets="CoreCompile" Condition="('$(EfcptExternalDataDir)' != '') and (Exists('$(EfcptExternalDataDir)'))">
    <ItemGroup>
      <Compile Include="$(EfcptExternalDataDir)**\*.g.cs" />
    </ItemGroup>
    <Message Text="Including external data files from: $(EfcptExternalDataDir)" Importance="normal" />
  </Target>
  <!--Clean target: remove efcpt output directory when 'dotnet clean' is run-->
  <Target Name="EfcptClean" AfterTargets="Clean" Condition="'$(EfcptEnabled)' == 'true'">
    <Message Importance="normal" Text="Cleaning efcpt output: $(EfcptOutput)" />
    <RemoveDir Condition="Exists('$(EfcptOutput)')" Directories="$(EfcptOutput)" />
  </Target>
  <!--Build Profiling: Finalize profiling at the end of the build pipeline.-->
  <Target Name="_EfcptFinalizeProfiling" AfterTargets="Build" Condition="('$(EfcptEnabled)' == 'true') and ('$(EfcptEnableProfiling)' == 'true')">
    <FinalizeBuildProfiling BuildSucceeded="true" Configuration="$(Configuration)" OutputPath="$(EfcptProfilingOutput)" ProjectName="$(MSBuildProjectName)" ProjectPath="$(MSBuildProjectFullPath)" TargetFramework="$(TargetFramework)" />
  </Target>
</Project>
